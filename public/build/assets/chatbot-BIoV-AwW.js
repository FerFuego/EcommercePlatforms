document.addEventListener("DOMContentLoaded",()=>{const u=document.getElementById("chatbot-button"),l=document.getElementById("chatbot-window"),g=document.getElementById("close-chatbot"),h=document.getElementById("chatbot-form"),d=document.getElementById("chatbot-input"),c=document.getElementById("chatbot-messages"),i=document.getElementById("typing-indicator");let t=JSON.parse(localStorage.getItem("chatbot_messages"))||[];u.addEventListener("click",()=>{l.classList.toggle("open"),r()}),g.addEventListener("click",()=>{l.classList.remove("open")}),t.length>0&&t.forEach(s=>o(s.role,s.content,!1)),h.addEventListener("submit",async s=>{s.preventDefault();const n=d.value.trim();if(n){d.value="",o("user",n),t.push({role:"user",content:n}),m(),i.style.display="block",r();try{const e=await(await fetch("/api/chatbot/message",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")},body:JSON.stringify({messages:t})})).json();i.style.display="none",e.message?(o("assistant",e.message),t.push({role:"assistant",content:e.message}),m()):o("assistant","Lo siento, hubo un error al procesar tu mensaje.")}catch(a){i.style.display="none",o("assistant","Error de conexiÃ³n. Por favor intenta de nuevo."),console.error("Chatbot Error:",a)}}});function o(s,n,a=!0){const e=document.createElement("div");e.className=`message ${s}`,s==="assistant"?e.innerHTML=marked.parse(n):e.textContent=n,a||(e.style.animation="none"),c.appendChild(e),r()}function m(){t.length>20&&(t=t.slice(-20)),localStorage.setItem("chatbot_messages",JSON.stringify(t))}function r(){c.scrollTop=c.scrollHeight}});
